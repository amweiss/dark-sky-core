name: $(Build.SourceBranchName)_$(Build.BuildId)
trigger:
- master

resources:
- repo: self
  fetchDepth: 1
queue:
  name: Hosted VS2017

steps:
- script: dotnet restore

- script: choco install codecov

- script: dotnet build src --configuration $(BuildConfiguration)

- script: dotnet pack --configuration $(BuildConfiguration) --include-symbols -o (Build.ArtifactStagingDirectory) src

- powershell: |
   if ($env:BUILD_REASON -eq "PullRequest") {
     dotnet test test --logger trx --collect "Code coverage"
   }
   else {
     dotnet test test --filter "FullyQualifiedName~DarkSky.UnitTests"
   }
  displayName: Test
  env:
    DarkSkyApiKey: $(DarkSkyApiKey)

- task: PublishTestResults@2
  inputs:
    testRunner: VSTest
    testResultsFiles: '**/*.trx'

- task: PublishBuildArtifacts@1