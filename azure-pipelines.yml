name: $(Build.DefinitionName)_$(Build.DefinitionVersion)_$(Build.BuildId)_$(Build.BuildNumber)
trigger:
- master

resources:
- repo: self
  fetchDepth: 1
queue:
  name: Hosted VS2017

steps:
- task: DotNetCoreCLI@2
  displayName: Restore
  inputs:
    command: restore

- powershell: 'choco install codecov'
  displayName: 'Install tools'

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: custom

    projects: src

    custom: build

    arguments: '--configuration $(BuildConfiguration)'


- task: DotNetCoreCLI@2
  displayName: Pack
  inputs:
    command: custom

    projects: src

    custom: pack

    arguments: '--configuration $(BuildConfiguration) --include-symbols -o $(Build.ArtifactStagingDirectory)'


- powershell: |
   if ($env:BUILD_REASON -eq "PullRequest") {
     dotnet test test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput="../coverage.xml"
     codecov -f "coverage.xml"
   }
   else {
     dotnet test test --filter "FullyQualifiedName~DarkSky.UnitTests"
   }
  displayName: Test
  env:
    DarkSkyApiKey: $(DarkSkyApiKey)

